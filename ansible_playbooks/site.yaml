---
- name: generate SSH key
  hosts: local
  vars:
    ansible_remote_tmp: /tmp
  tasks:

    - name: "generate SSH key for ssh_users"
      openssh_keypair:
        path: "/root/ansible_playbooks/.ssh_keys/{{ item }}"
        type: ed25519
        state: present
        comment: "{{ item }} generated by ansible"
      loop: "{{ ssh_user }}"

- name: "Add ssh users to system"
  hosts: vps
  tasks:

    - name: Add users
      user:
        name: "{{ item }}"
        comment: "User {{ item }}"
        shell: /bin/bash/
      loop: "{{ ssh_user }}"

    - name: "Add authorized_keys for users"
      authorized_key:
        user: "{{ item }}"
        state: present
        key: "{{ lookup('file','/root/ansible_playbooks/.ssh_keys/' + item + '.pub') }}"
      loop: "{{ ssh_user }}"

    - name: allow open ports
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop: "{{ open_ports }}"
      tags: firewall

    - name: Default policy to deny and enable ufw
      ufw:
        state: enabled
        policy: deny
      tags: firewall

- name: Docker for VPS
  hosts: vps
  pre_tasks:
    - name: Entry message
      debug:
        msg: "Docker installation from geerlingguy.docker role"
      tags: docker
  roles:
    - {role: 'geerlingguy.docker', tags: 'docker'}

  tasks:

    - name: Install required packages
      apt:
        pkg:
          - python3-pip
          - python3-setuptools
        state: latest
        update_cache: true
      tags: docker_run

    - name: install docker python module
      pip:
        name: docker
      tags: docker_run

- import_playbook: docker_apps.yml
  # in my case - if I use {} i have to use also " "
  # Ansible runs task by task
