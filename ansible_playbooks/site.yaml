---
- name: Generate SSH key
  hosts: local
  vars:
    ansible_remote_tmp: /tmp
  tasks:
    - name: Check if SSH key directory exists
      ansible.builtin.file:
        path: "/root/ansible_playbooks/.ssh_keys"
        state: directory
        mode: '0700'

# .ssh_keys folder has to have 0700 permissions for root

    - name: "Generate SSH keys for users"
      community.crypto.openssh_keypair:
        path: "/root/ansible_playbooks/.ssh_keys/{{ item }}"
        type: ed25519
        comment: "{{ item }} generated by ansible"
      loop: "{{ ssh_user }}"

- name: "Add ssh users to system"
  hosts: vps
  tasks:

    - name: Add users
      ansible.builtin.user:
        name: "{{ item }}"
        comment: "User {{ item }}"
        shell: /bin/bash/
      loop: "{{ ssh_user }}"

    - name: "Add authorized_keys for users"
      ansible.posix.authorized_key:
        user: "{{ item }}"
        state: present
        key: "{{ lookup('file', '/root/ansible_playbooks/.ssh_keys/' + item + '.pub') }}"
      loop: "{{ ssh_user }}"

    - name: Allow open ports
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop: "{{ open_ports }}"
      tags: firewall

    - name: Default policy to deny and enable ufw
      community.general.ufw:
        state: enabled
        policy: deny
      tags: firewall

- name: Docker for VPS
  hosts: vps
  pre_tasks:
    - name: Entry message
      ansible.legacy.debug:
        msg: "Docker installation from geerlingguy.docker role"
      tags: docker

  roles:
    - {role: 'geerlingguy.docker', tags: 'docker'}

  tasks:

    - name: Install required packages
      ansible.legacy.apt:
        pkg:
          - python3-pip
          - python3-setuptools
        state: latest
        update_cache: true
      tags: docker_run

    - name: Install docker python module
      ansible.builtin.pip:
        name: docker
      tags: docker_run

- name: Import docker_apps
  import_playbook: docker_apps.yml
  # in my case - if I use {} i have to use also " "
  # Ansible runs task by task
